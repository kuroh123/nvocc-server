// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PortType {
  DRY_PORT
  SEA_PORT
}

enum RoleType {
  ADMIN
  CUSTOMER
  PORT
  DEPOT
  SALES
  MASTER_PORT
  HR
}

enum Status {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum CargoType {
  GENERAL
  HAZARDOUS
  REFRIGERATED
  BULK
  LIQUID
}

enum ContainerTypeCategory {
  DRY
  REEFER
  TANK
  FLAT_RACK
  OPEN_TOP
}

enum VesselType {
  CONTAINER_SHIP
  BULK_CARRIER
  TANKER
  RO_RO
  GENERAL_CARGO
}

enum EventType {
  PICKUP
  DELIVERY
  TRANSIT
  STORAGE
}

enum ProductType {
  EXPORT
  IMPORT
  TRANSSHIPMENT
}

model Tenant {
  id                          String   @id @default(cuid())
  name                        String
  app_abbr                    String   @unique
  website_url                 String?
  email                       String
  activation                  Boolean  @default(true)
  resend_activation_threshold Int      @default(3)
  language                    String   @default("en")
  template                    String   @default("default")
  app_version                 String   @default("1.0.0")
  app_status                  String   @default("active")
  app_msg                     String?
  prefix_booking              String   @default("BKG")
  prefix_bl                   String   @default("BL")
  password_expiry_days        Int      @default(90)
  max_user_sessions           Int      @default(5)
  booking_confirmation_text   String?
  currency_converter_api_key  String?
  audit_trail_anyoperation    Boolean  @default(true)
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt

  // Relations
  users User[]

  @@map("tenants")
}

model User {
  id              String    @id @default(cuid())
  tenantId        String
  email           String    @unique
  password        String
  firstName       String?
  lastName        String?
  phoneNumber     String?
  status          Status    @default(ACTIVE)
  isEmailVerified Boolean   @default(false)
  emailVerifiedAt DateTime?
  lastLoginAt     DateTime?
  profileImageUrl String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  roles          Role[]
  userSessions   UserSession[]
  refreshTokens  RefreshToken[]
  passwordResets PasswordReset[]
  activityLogs   ActivityLog[]
  Port           Port[]
  Terminal       Terminal[]

  @@map("users")
}

model Role {
  id          String   @id @default(cuid())
  name        RoleType @unique
  displayName String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users       User[]
  permissions Permission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "bookings.create"
  displayName String // e.g., "Create Bookings"
  description String?
  module      String // e.g., "bookings", "users", "reports"
  category    String? // e.g., "read", "write", "admin"
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  roles Role[]

  @@map("permissions")
}

model UserSession {
  id             String    @id @default(cuid())
  userId         String
  token          String    @unique
  activeRole     RoleType? // Current active role in this session
  ipAddress      String?
  userAgent      String?
  isActive       Boolean   @default(true)
  expiresAt      DateTime
  createdAt      DateTime  @default(now())
  lastActivityAt DateTime  @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  isRevoked Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model PasswordReset {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  isUsed    Boolean   @default(false)
  expiresAt DateTime
  createdAt DateTime  @default(now())
  usedAt    DateTime?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

// Application Data Models

model Currency {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique // USD, EUR, INR, etc.
  symbol    String?  // $, €, ₹, etc.
  status    Status   @default(ACTIVE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  countries          Country[]
  bankAccounts       BankAccount[]
  exchangeRatesFrom  CurrencyExchangeRate[] @relation("FromCurrency")
  exchangeRatesTo    CurrencyExchangeRate[] @relation("ToCurrency")

  @@map("currencies")
}

model State {
  id        String   @id @default(cuid())
  name      String
  code      String?
  countryId String
  status    Status   @default(ACTIVE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  country      Country       @relation(fields: [countryId], references: [id], onDelete: Cascade)
  agents       Agent[]
  bankAccounts BankAccount[]
  operators    Operator[]
  depots       Depot[]

  @@map("states")
}

model Agent {
  id                  String   @id @default(cuid())
  name                String
  companyName         String
  ownOffice           Boolean  @default(false)
  status              Status   @default(ACTIVE)
  portId              String?
  email               String   @unique
  addressLine1        String?
  addressLine2        String?
  city                String?
  stateId             String?
  zipCode             String?
  countryId           String?
  address             String?
  mobNum              String?
  telNum              String?
  licenceNum          String?
  expContactDetails   String?
  impContactDetails   String?
  gstNum              String?
  panNum              String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  port         Port?         @relation(fields: [portId], references: [id], onDelete: SetNull)
  state        State?        @relation(fields: [stateId], references: [id], onDelete: SetNull)
  country      Country?      @relation(fields: [countryId], references: [id], onDelete: SetNull)
  bankAccounts BankAccount[]
  pickupTariffs Tariff[] @relation("PickupAgent")
  nextTariffs   Tariff[] @relation("NextAgent")
  uploads      Upload[]

  @@map("agents")
}

model Charge {
  id          String   @id @default(cuid())
  name        String
  displayName String
  status      Status   @default(ACTIVE)
  sacHsnCode  String?
  flag        String?
  note        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("charges")
}

model CurrencyExchangeRate {
  id             String   @id @default(cuid())
  status         Status   @default(ACTIVE)
  fromCurrencyId String
  toCurrencyId   String
  exchangeRate   Float
  lowerRate      Float?
  upperRate      Float?
  validFromDt    DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  fromCurrency Currency @relation("FromCurrency", fields: [fromCurrencyId], references: [id], onDelete: Cascade)
  toCurrency   Currency @relation("ToCurrency", fields: [toCurrencyId], references: [id], onDelete: Cascade)

  @@map("currency_exchange_rates")
}

model Vessel {
  id        String     @id @default(cuid())
  name      String
  type      VesselType
  status    Status     @default(ACTIVE)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relations
  schedules VesselSchedule[]

  @@map("vessels")
}

model VesselSchedule {
  id                    String    @id @default(cuid())
  vesselId              String
  voyage                String?
  serviceName           String?
  gateOpen              DateTime?
  cutOff                DateTime?
  pickupLocation        String?
  pickupTerminalId      String?
  etaDt                 DateTime?
  etdDt                 DateTime?
  nextPortLocation      String?
  nextPortTerminalId    String?
  nextPortArrivalDt     DateTime?
  pcNum                 String?
  pcDt                  DateTime?
  sobDt                 DateTime?
  ataDt                 DateTime?
  sobDescription        String?
  ataDescription        String?
  imNum                 String?
  imDt                  DateTime?
  imoCode               String?
  callSign              String?
  lineCode              String?
  lineIgmNum            String?
  lineIgmDt             DateTime?
  space20ft             Int?
  space40ft             Int?
  tba                   String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  vessel             Vessel    @relation(fields: [vesselId], references: [id], onDelete: Cascade)
  pickupTerminal     Terminal? @relation("PickupTerminal", fields: [pickupTerminalId], references: [id], onDelete: SetNull)
  nextPortTerminal   Terminal? @relation("NextPortTerminal", fields: [nextPortTerminalId], references: [id], onDelete: SetNull)

  @@map("vessel_schedules")
}

model Cargo {
  id         String     @id @default(cuid())
  name       String
  status     Status     @default(ACTIVE)
  cargoType  CargoType
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // Relations
  commodities Commodity[]

  @@map("cargo")
}

model Commodity {
  id          String   @id @default(cuid())
  name        String
  cargoId     String
  description String?
  status      Status   @default(ACTIVE)
  code        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  cargo Cargo @relation(fields: [cargoId], references: [id], onDelete: Cascade)

  @@map("commodities")
}

model ContainerType {
  id        String                  @id @default(cuid())
  name      String
  isoCode   String                  @unique
  type      ContainerTypeCategory
  status    Status                  @default(ACTIVE)
  notes     String?
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt

  // Relations
  tariffs Tariff[]

  @@map("container_types")
}

model BankAccount {
  id           String   @id @default(cuid())
  agentId      String
  accountName  String
  bankName     String
  bankBranch   String?
  currencyId   String
  addressLine1 String?
  addressLine2 String?
  city         String?
  stateId      String?
  zipCode      String?
  countryId    String?
  ifscCode     String?
  swiftCode    String?
  accountNum   String
  status       Status   @default(ACTIVE)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  agent    Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  currency Currency  @relation(fields: [currencyId], references: [id], onDelete: Restrict)
  state    State?    @relation(fields: [stateId], references: [id], onDelete: SetNull)
  country  Country?  @relation(fields: [countryId], references: [id], onDelete: SetNull)

  @@map("bank_accounts")
}

model Operator {
  id           String   @id @default(cuid())
  name         String
  companyName  String
  portId       String?
  status       Status   @default(ACTIVE)
  addressLine1 String?
  addressLine2 String?
  city         String?
  stateId      String?
  zipCode      String?
  countryId    String?
  address      String?
  mobNum       String?
  telNum       String?
  email        String?  @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  port    Port?    @relation(fields: [portId], references: [id], onDelete: SetNull)
  state   State?   @relation(fields: [stateId], references: [id], onDelete: SetNull)
  country Country? @relation(fields: [countryId], references: [id], onDelete: SetNull)

  @@map("operators")
}

model Depot {
  id           String   @id @default(cuid())
  name         String
  company      String
  portId       String?
  status       Status   @default(ACTIVE)
  addressLine1 String?
  addressLine2 String?
  city         String?
  stateId      String?
  zipCode      String?
  countryId    String?
  gstNum       String?
  panNum       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  port    Port?    @relation(fields: [portId], references: [id], onDelete: SetNull)
  state   State?   @relation(fields: [stateId], references: [id], onDelete: SetNull)
  country Country? @relation(fields: [countryId], references: [id], onDelete: SetNull)
  uploads Upload[]

  @@map("depots")
}

model Tariff {
  id              String      @id @default(cuid())
  eventType       EventType
  productType     ProductType
  containerTypeId String
  qty             Int
  rate            Float
  pickAgentId     String?
  pickPortId      String?
  pickTerminalId  String?
  nextAgentId     String?
  nextPortId      String?
  nextTerminalId  String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  containerType  ContainerType @relation(fields: [containerTypeId], references: [id], onDelete: Cascade)
  pickAgent      Agent?        @relation("PickupAgent", fields: [pickAgentId], references: [id], onDelete: SetNull)
  pickPort       Port?         @relation("PickupPort", fields: [pickPortId], references: [id], onDelete: SetNull)
  pickTerminal   Terminal?     @relation("PickupTerminal", fields: [pickTerminalId], references: [id], onDelete: SetNull)
  nextAgent      Agent?        @relation("NextAgent", fields: [nextAgentId], references: [id], onDelete: SetNull)
  nextPort       Port?         @relation("NextPort", fields: [nextPortId], references: [id], onDelete: SetNull)
  nextTerminal   Terminal?     @relation("NextTerminal", fields: [nextTerminalId], references: [id], onDelete: SetNull)

  @@map("tariffs")
}

model Country {
  id              String   @id @default(cuid())
  name            String
  codeChar2       String   @unique
  codeChar3       String   @unique
  unRegion        String?
  unSubregion     String?
  currencyId      String?
  invoiceRoundOff String?
  status          Status   @default(ACTIVE)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  currency     Currency?     @relation(fields: [currencyId], references: [id], onDelete: SetNull)
  ports        Port[]
  states       State[]
  agents       Agent[]
  bankAccounts BankAccount[]
  operators    Operator[]
  depots       Depot[]

  @@map("countries")
}

model Port {
  id             String   @id @default(cuid())
  name           String
  portType       PortType
  status         Status   @default(ACTIVE)
  countryId      String
  itaCode        String?  @unique
  portCode       String?  @unique
  customsDetails String?
  createdById    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  country         Country    @relation(fields: [countryId], references: [id], onDelete: Cascade)
  createdBy       User?      @relation(fields: [createdById], references: [id], onDelete: SetNull)
  terminals       Terminal[]
  uploads         Upload[]
  agents          Agent[]
  operators       Operator[]
  depots          Depot[]
  pickupTariffs   Tariff[]   @relation("PickupPort")
  nextTariffs     Tariff[]   @relation("NextPort")

  @@map("ports")
}

model Terminal {
  id          String   @id @default(cuid())
  name        String   @unique
  portId      String
  status      Status   @default(ACTIVE)
  description String?
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  port                     Port             @relation(fields: [portId], references: [id], onDelete: Cascade)
  createdBy                User?            @relation(fields: [createdById], references: [id], onDelete: SetNull)
  uploads                  Upload[]
  pickupVesselSchedules    VesselSchedule[] @relation("PickupTerminal")
  nextPortVesselSchedules  VesselSchedule[] @relation("NextPortTerminal")
  pickupTariffs            Tariff[]         @relation("PickupTerminal")
  nextTariffs              Tariff[]         @relation("NextTerminal")

  @@map("terminals")
}

// Uploads

model Upload {
  id        String   @id @default(cuid())
  name      String
  size      Int
  fileUrl   String
  createdAt DateTime @default(now())

  // Possible owners
  portId     String?
  terminalId String?
  agentId    String?
  depotId    String?

  // Relations
  port     Port?     @relation(fields: [portId], references: [id], onDelete: Cascade)
  terminal Terminal? @relation(fields: [terminalId], references: [id], onDelete: Cascade)
  agent    Agent?    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  depot    Depot?    @relation(fields: [depotId], references: [id], onDelete: Cascade)
}

// Audit Trail / Activity Log

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String // LOGIN, LOGOUT, ROLE_SWITCH, etc.
  entity    String? // What was affected
  entityId  String? // ID of affected entity
  details   Json? // Additional details
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("activity_logs")
}
